version = 1

[install]
python.pkg-path = "python313"
uv.pkg-path = "uv"
comfyui-scripts.pkg-path = "flox/comfyui-scripts"

[vars]
COMFYUI_HOST = "localhost"
COMFYUI_PORT = "8188"
COMFYUI_WORKFLOWS = "/home/daedalus/comfyui-work/user/default/workflows"

[hook]
on-activate = '''
# Create workflows symlink if target exists
if [ -d "$COMFYUI_WORKFLOWS" ] && [ ! -e "workflows" ]; then
  ln -s "$COMFYUI_WORKFLOWS" workflows
fi

# Setup Python venv
FLOX_PYTHON=$(which python)
if [ ! -d ".venv" ]; then
  uv venv .venv --python "$FLOX_PYTHON"
fi

unset PYTHONPATH
export VIRTUAL_ENV_DISABLE_PROMPT=1
source .venv/bin/activate

# Reinstall if source changed or CLI missing
if [ ! -f ".venv/.deps_installed" ] || [ ! -f ".venv/bin/comfyui-queue" ] || \
   [ "src/comfyui_client/cli.py" -nt ".venv/.deps_installed" ]; then
  uv pip install -e ".[dev]" --quiet
  touch .venv/.deps_installed
fi
'''

[profile]
common = '''
export PATH="$FLOX_ENV_PROJECT/.venv/bin:$PATH"
export VIRTUAL_ENV_DISABLE_PROMPT=1
'''

bash = '''
unset PYTHONPATH
'''

zsh = '''
unset PYTHONPATH
'''

fish = '''
set -e PYTHONPATH 2>/dev/null
'''
